

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>devito.arguments &mdash; Devito 1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Devito 1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Devito
          

          
          </a>

          
            
            
              <div class="version">
                0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../download.html">Download</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Example Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devito.html">API Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Devito</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>devito.arguments</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for devito.arguments</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">abc</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">chain</span>

<span class="kn">from</span> <span class="nn">devito.exceptions</span> <span class="k">import</span> <span class="n">InvalidArgument</span>
<span class="kn">from</span> <span class="nn">devito.tools</span> <span class="k">import</span> <span class="n">filter_ordered</span><span class="p">,</span> <span class="n">flatten</span><span class="p">,</span> <span class="n">GenericVisitor</span>
<span class="kn">from</span> <span class="nn">devito.function</span> <span class="k">import</span> <span class="n">CompositeFunction</span><span class="p">,</span> <span class="n">SymbolicFunction</span>
<span class="kn">from</span> <span class="nn">devito.dimension</span> <span class="k">import</span> <span class="n">Dimension</span>


<span class="sd">&quot;&quot;&quot; This module contains a set of classes and functions to deal with runtime arguments</span>
<span class="sd">to Operators. It represents the arguments and their relationships as a DAG (N, E) where</span>
<span class="sd">every node (N) is represented by an object of :class:`Parameter` and every edge is an</span>
<span class="sd">object of class :class:`Dependency`.</span>

<span class="sd">The various class hierarchies are explained here:</span>
<span class="sd">Parameter: Any node of the dependency graph has to necessarily be of this type. The node</span>
<span class="sd">           may or may not represent an actual runtime argument passed to the kernel.</span>
<span class="sd">Argument: Subclass of Parameter. This represents a node in the dependency graph directly</span>
<span class="sd">          corresponding to a runtime argument passed to the kernel.</span>

<span class="sd">             Parameter</span>
<span class="sd">                 |</span>
<span class="sd">        -------------------</span>
<span class="sd">DimensionParameter        |</span>
<span class="sd">                          |</span>
<span class="sd">                       Argument</span>
<span class="sd">                          |</span>
<span class="sd">                          |</span>
<span class="sd">                --------------------</span>
<span class="sd">                |         |        |</span>
<span class="sd">        ScalarArgument    |        |</span>
<span class="sd">                    TensorArgument |</span>
<span class="sd">                                PtrArgument</span>

<span class="sd">ArgumentEngine: The main external API for this module. It encapsulates all the argument</span>
<span class="sd">                derivation and verification logic.</span>

<span class="sd">ArgumentVisitor: Visits objects of :class:`function.Basic` types to return appropriate</span>
<span class="sd">                 objects from the above parameter-argument hierarchy.</span>

<span class="sd">ValueVisitor: Used by the argument derivation method to derive the value of each parameter</span>
<span class="sd">              based on the dependency tree.</span>

<span class="sd">Dependency: Edges of the dependency graph are represented by objects of this class.</span>

<span class="sd">UnevaluatedDependency: A &quot;future&quot; object representing an argument derivation that is yet</span>
<span class="sd">                       to happen.</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="Parameter"><a class="viewcode-back" href="../../devito.html#devito.arguments.Parameter">[docs]</a><span class="k">class</span> <span class="nc">Parameter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Abstract base class for any object that represents a node in the dependency</span>
<span class="sd">        graph. It may or may not represent a runtime argument.</span>

<span class="sd">    :param name: Name of the parameter</span>
<span class="sd">    :param dependencies: A list of :class:`Dependency` objects that represent all the</span>
<span class="sd">                         incoming edges into this node of the graph.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_DimensionParameter</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_Argument</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_ScalarArgument</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_TensorArgument</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_PtrArgument</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="n">dependencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider</span> <span class="o">=</span> <span class="n">provider</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gets_value_from</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_Value</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">verified_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_Verify</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, Depends: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">))</span></div>


<div class="viewcode-block" id="DimensionParameter"><a class="viewcode-back" href="../../devito.html#devito.arguments.DimensionParameter">[docs]</a><span class="k">class</span> <span class="nc">DimensionParameter</span><span class="p">(</span><span class="n">Parameter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parameter object (node in the dependency graph) that represents a</span>
<span class="sd">        :class:`Dimension`. A dimension object plays an important role in value derivation</span>
<span class="sd">        and verification but does not represent a runtime argument itself (since it</span>
<span class="sd">        provides multiple ScalarArguments).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_DimensionParameter</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DimensionParameter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">)</span></div>


<div class="viewcode-block" id="Argument"><a class="viewcode-back" href="../../devito.html#devito.arguments.Argument">[docs]</a><span class="k">class</span> <span class="nc">Argument</span><span class="p">(</span><span class="n">Parameter</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; Base class for any object that represents a run time argument for</span>
<span class="sd">        generated kernels. It is necessarily a node in the dependency graph.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_Argument</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Argument</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span></div>


<div class="viewcode-block" id="ScalarArgument"><a class="viewcode-back" href="../../devito.html#devito.arguments.ScalarArgument">[docs]</a><span class="k">class</span> <span class="nc">ScalarArgument</span><span class="p">(</span><span class="n">Argument</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; Class representing scalar arguments that a kernel might expect.</span>
<span class="sd">        Most commonly used to pass dimension sizes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_ScalarArgument</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="TensorArgument"><a class="viewcode-back" href="../../devito.html#devito.arguments.TensorArgument">[docs]</a><span class="k">class</span> <span class="nc">TensorArgument</span><span class="p">(</span><span class="n">Argument</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; Class representing tensor arguments that a kernel might expect.</span>
<span class="sd">        Most commonly used to pass numpy-like multi-dimensional arrays.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_TensorArgument</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dependencies</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TensorArgument</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span>
                                             <span class="n">dependencies</span> <span class="o">+</span> <span class="p">[</span><span class="n">ValueDependency</span><span class="p">(</span><span class="n">provider</span><span class="p">)],</span>
                                             <span class="n">provider</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span></div>


<div class="viewcode-block" id="PtrArgument"><a class="viewcode-back" href="../../devito.html#devito.arguments.PtrArgument">[docs]</a><span class="k">class</span> <span class="nc">PtrArgument</span><span class="p">(</span><span class="n">Argument</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot; Class representing arbitrary arguments that a kernel might expect.</span>
<span class="sd">        These are passed as void pointers and then promptly casted to their</span>
<span class="sd">        actual type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">is_PtrArgument</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PtrArgument</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">provider</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span>
                                          <span class="p">[</span><span class="n">ValueDependency</span><span class="p">(</span><span class="n">provider</span><span class="p">)],</span> <span class="n">provider</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span></div>


<div class="viewcode-block" id="ArgumentEngine"><a class="viewcode-back" href="../../devito.html#devito.arguments.ArgumentEngine">[docs]</a><span class="k">class</span> <span class="nc">ArgumentEngine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class that encapsulates the argument derivation and verification subsystem</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ispace</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">dle_arguments</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dle_arguments</span> <span class="o">=</span> <span class="n">dle_arguments</span>
        <span class="n">argument_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_arguments_list</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">filter_ordered</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">argument_list</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_Argument</span><span class="p">],</span>
                                        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimension_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">argument_list</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_DimensionParameter</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span> <span class="o">=</span> <span class="n">retrieve_offsets</span><span class="p">(</span><span class="n">ispace</span><span class="p">)</span>

<div class="viewcode-block" id="ArgumentEngine.handle"><a class="viewcode-back" href="../../devito.html#devito.arguments.ArgumentEngine.handle">[docs]</a>    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The main method by which the :class:`Operator` interacts with this class.</span>
<span class="sd">            The arguments passed into Operator.apply() all end up in kwargs here.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">user_autotune</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;autotune&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_adjust</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_children_of_composites</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive_values</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># The following is only being done to update the autotune flag. The actual value</span>
        <span class="c1"># derivation for the dle arguments has moved inside the above _derive_values</span>
        <span class="c1"># method.</span>
        <span class="c1"># TODO: Refactor so this is not required</span>
        <span class="n">dim_sizes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">runtime_dim_extent</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
                          <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">])</span>
        <span class="n">dle_arguments</span><span class="p">,</span> <span class="n">dle_autotune</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dle_arguments</span><span class="p">(</span><span class="n">dim_sizes</span><span class="p">)</span>

        <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verify</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>

        <span class="n">arguments</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

        <span class="k">return</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">user_autotune</span> <span class="ow">and</span> <span class="n">dle_autotune</span></div>

    <span class="k">def</span> <span class="nf">_offset_adjust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offsets</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">_build_arguments_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="c1"># Pass through SymbolicFunction</span>
        <span class="n">symbolic_functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">SymbolicFunction</span><span class="p">)]</span>
        <span class="n">dim_dep_mapper</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>  <span class="c1"># Mapper for dependencies between dimensions</span>
        <span class="n">tensor_arguments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">symbolic_functions</span><span class="p">:</span>
            <span class="n">argument</span> <span class="o">=</span> <span class="n">ArgumentVisitor</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">tensor_arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">indices</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">dim_dep_mapper</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueDependency</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="n">i</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dle_arguments</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">dim_dep_mapper</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">argument</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueDependency</span><span class="p">(</span><span class="n">derive_dle_arg_value</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="n">arg</span><span class="p">))</span>

        <span class="c1"># Record dependencies in Dimensions</span>
        <span class="n">dim_param_mapper</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">DimensionParameter</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span>
                                        <span class="n">dim_dep_mapper</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

        <span class="c1"># Dimensions that are in parameters but not directly referenced in the expressions</span>
        <span class="n">more</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">x</span><span class="p">,</span> <span class="n">DimensionParameter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[]))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span>
                     <span class="n">dim_dep_mapper</span><span class="p">])</span>
        <span class="n">dim_param_mapper</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">more</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_Stepping</span><span class="p">]:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">dim_param_mapper</span><span class="p">[</span><span class="n">dim</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">dependencies</span>
            <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ValueDependency</span><span class="p">(</span><span class="n">dim_param_mapper</span><span class="p">[</span><span class="n">dim</span><span class="p">]))</span>

        <span class="n">dimension_parameters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dim_param_mapper</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">scalar_arguments</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">([</span><span class="n">ArgumentVisitor</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dimension_parameters</span><span class="p">])</span>

        <span class="n">other_arguments</span> <span class="o">=</span> <span class="p">[</span><span class="n">ArgumentVisitor</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parameters</span>
                           <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tensor_arguments</span> <span class="o">+</span> <span class="n">scalar_arguments</span><span class="p">]</span>

        <span class="n">other_arguments</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">other_arguments</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">tensor_arguments</span> <span class="o">+</span> <span class="n">dimension_parameters</span> <span class="o">+</span> <span class="n">scalar_arguments</span> <span class="o">+</span>\
            <span class="n">other_arguments</span>

    <span class="k">def</span> <span class="nf">_extract_children_of_composites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">new_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># If we&#39;ve been passed CompositeFunction objects as kwargs,</span>
        <span class="c1"># they might have children that need to be substituted as well.</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">CompositeFunction</span><span class="p">):</span>
                <span class="n">orig_param_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>
                <span class="c1"># If I have been passed a parameter, I must have seen it before</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">orig_param_l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InvalidArgument</span><span class="p">(</span><span class="s2">&quot;Parameter </span><span class="si">%s</span><span class="s2"> does not exist in expressions &quot;</span> <span class="o">+</span>
                                          <span class="s2">&quot;passed to this Operator&quot;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
                <span class="c1"># We&#39;ve made sure the list isn&#39;t empty. Names should be unique so it</span>
                <span class="c1"># should have exactly one entry</span>
                <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orig_param_l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">orig_param</span> <span class="o">=</span> <span class="n">orig_param_l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Pull out the children and add them to kwargs</span>
                <span class="k">for</span> <span class="n">orig_child</span><span class="p">,</span> <span class="n">new_child</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">orig_param</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
                    <span class="n">new_params</span><span class="p">[</span><span class="n">orig_child</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_child</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">_dle_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim_sizes</span><span class="p">):</span>
        <span class="c1"># Add user-provided block sizes, if any</span>
        <span class="n">dle_arguments</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">autotune</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dle_arguments</span><span class="p">:</span>
            <span class="n">dim_size</span> <span class="o">=</span> <span class="n">dim_sizes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">original_dim</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dim_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidArgument</span><span class="p">(</span><span class="s1">&#39;Unable to derive size of dimension </span><span class="si">%s</span><span class="s1"> from &#39;</span>
                                      <span class="s1">&#39;defaults. Please provide an explicit &#39;</span>
                                      <span class="s1">&#39;value.&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="o">.</span><span class="n">original_dim</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dle_arguments</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">argument</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">dim_size</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="n">dle_arguments</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">argument</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">value</span>
                    <span class="n">autotune</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dle_arguments</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">argument</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim_size</span>
        <span class="k">return</span> <span class="n">dle_arguments</span><span class="p">,</span> <span class="n">autotune</span>

    <span class="k">def</span> <span class="nf">_derive_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Populate values for all the arguments. The values provided in kwargs will</span>
<span class="sd">            be used wherever provided. The values for the rest of the arguments will be</span>
<span class="sd">            derived from the ones provided. The default values for the tensors come from</span>
<span class="sd">            the data property of the symbols used in the Operator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="n">get_value</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">values</span><span class="p">))</span>
                              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">])</span>

        <span class="n">dimension_values</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension_params</span><span class="p">])</span>

        <span class="c1"># Make sure we&#39;ve used all arguments passed</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidArgument</span><span class="p">(</span><span class="s2">&quot;Unknown arguments passed: &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="c1"># Derive values for other arguments</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">known_values</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                                 <span class="n">dimension_values</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
                <span class="n">provided_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_value</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">known_values</span><span class="p">)</span>
                                   <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">gets_value_from</span><span class="p">]</span>
                <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">provided_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="n">provided_values</span><span class="p">)</span>

        <span class="c1"># Second pass to evaluate any Unevaluated dependencies from the first pass</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">UnevaluatedDependency</span><span class="p">):</span>
                <span class="n">values</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">_verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="n">verify</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">verify</span> <span class="o">=</span> <span class="n">verify</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">verify</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">verified_by</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">verify</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Dimension</span><span class="p">)]</span></div>


<div class="viewcode-block" id="ArgumentVisitor"><a class="viewcode-back" href="../../devito.html#devito.arguments.ArgumentVisitor">[docs]</a><span class="k">class</span> <span class="nc">ArgumentVisitor</span><span class="p">(</span><span class="n">GenericVisitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Visits types to return their runtime arguments</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ArgumentVisitor.visit_SymbolicFunction"><a class="viewcode-back" href="../../devito.html#devito.arguments.ArgumentVisitor.visit_SymbolicFunction">[docs]</a>    <span class="k">def</span> <span class="nf">visit_SymbolicFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TensorArgument</span><span class="p">(</span><span class="n">o</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArgumentVisitor.visit_Argument"><a class="viewcode-back" href="../../devito.html#devito.arguments.ArgumentVisitor.visit_Argument">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Argument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">o</span></div>

<div class="viewcode-block" id="ArgumentVisitor.visit_DimensionParameter"><a class="viewcode-back" href="../../devito.html#devito.arguments.ArgumentVisitor.visit_DimensionParameter">[docs]</a>    <span class="k">def</span> <span class="nf">visit_DimensionParameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="n">dependency</span> <span class="o">=</span> <span class="n">ValueDependency</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">ScalarArgument</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">size_name</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="p">[</span><span class="n">dependency</span><span class="p">])</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">ScalarArgument</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">start_name</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="p">[</span><span class="n">dependency</span><span class="p">])</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">ScalarArgument</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">end_name</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="p">[</span><span class="n">dependency</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">size</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]</span></div>

<div class="viewcode-block" id="ArgumentVisitor.visit_Object"><a class="viewcode-back" href="../../devito.html#devito.arguments.ArgumentVisitor.visit_Object">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">PtrArgument</span><span class="p">(</span><span class="n">o</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArgumentVisitor.visit_Array"><a class="viewcode-back" href="../../devito.html#devito.arguments.ArgumentVisitor.visit_Array">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TensorArgument</span><span class="p">(</span><span class="n">o</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArgumentVisitor.visit_Scalar"><a class="viewcode-back" href="../../devito.html#devito.arguments.ArgumentVisitor.visit_Scalar">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ScalarArgument</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="p">[],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span></div>

<div class="viewcode-block" id="ArgumentVisitor.visit_Constant"><a class="viewcode-back" href="../../devito.html#devito.arguments.ArgumentVisitor.visit_Constant">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Constant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="c1"># TODO: Add option for delayed query of default value</span>
        <span class="k">return</span> <span class="n">ScalarArgument</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="p">[</span><span class="n">ValueDependency</span><span class="p">(</span><span class="n">o</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">o</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ValueVisitor"><a class="viewcode-back" href="../../devito.html#devito.arguments.ValueVisitor">[docs]</a><span class="k">class</span> <span class="nc">ValueVisitor</span><span class="p">(</span><span class="n">GenericVisitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Visits types to derive their value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">consumer</span><span class="p">,</span> <span class="n">known_values</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span> <span class="o">=</span> <span class="n">consumer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">known_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">known_values</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                  <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ValueVisitor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="ValueVisitor.visit_Function"><a class="viewcode-back" href="../../devito.html#devito.arguments.ValueVisitor.visit_Function">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="p">,</span> <span class="n">TensorArgument</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">_data_buffer</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">data</span></div>

<div class="viewcode-block" id="ValueVisitor.visit_Constant"><a class="viewcode-back" href="../../devito.html#devito.arguments.ValueVisitor.visit_Constant">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Constant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">data</span></div>

<div class="viewcode-block" id="ValueVisitor.visit_Dependency"><a class="viewcode-back" href="../../devito.html#devito.arguments.ValueVisitor.visit_Dependency">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">param</span><span class="p">)</span></div>

<div class="viewcode-block" id="ValueVisitor.visit_function"><a class="viewcode-back" href="../../devito.html#devito.arguments.ValueVisitor.visit_function">[docs]</a>    <span class="k">def</span> <span class="nf">visit_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">o</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_values</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span></div>

<div class="viewcode-block" id="ValueVisitor.visit_Object"><a class="viewcode-back" href="../../devito.html#devito.arguments.ValueVisitor.visit_Object">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">value</span></div>

<div class="viewcode-block" id="ValueVisitor.visit_object"><a class="viewcode-back" href="../../devito.html#devito.arguments.ValueVisitor.visit_object">[docs]</a>    <span class="k">def</span> <span class="nf">visit_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">o</span></div>

<div class="viewcode-block" id="ValueVisitor.visit_DimensionParameter"><a class="viewcode-back" href="../../devito.html#devito.arguments.ValueVisitor.visit_DimensionParameter">[docs]</a>    <span class="k">def</span> <span class="nf">visit_DimensionParameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Called when some Argument&#39;s value is being derived and the dependency tree</span>
<span class="sd">            was followed till a :class:`DimensionParameter` object. The Argument for</span>
<span class="sd">            which we are deriving the value is self.consumer</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># We are being asked to provide a default value for dim_start</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">o</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">start_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_values</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">known_values</span><span class="p">[</span><span class="n">o</span><span class="p">],</span>
                                                     <span class="n">UnevaluatedDependency</span><span class="p">):</span>
            <span class="n">provided_values</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">known_values</span><span class="p">[</span><span class="n">o</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">provided_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_value</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_values</span><span class="p">)</span>
                               <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">gets_value_from</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">provided_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">provided_values</span><span class="p">):</span>
                <span class="n">unknown_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">obj</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">gets_value_from</span>
                                <span class="k">if</span> <span class="n">get_value</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_values</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>

                <span class="k">def</span> <span class="nf">late_evaluate_dim_size</span><span class="p">(</span><span class="n">consumer</span><span class="p">,</span> <span class="n">known_values</span><span class="p">,</span> <span class="n">partial_values</span><span class="p">):</span>
                    <span class="n">known</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">known_values</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">unknown_args</span><span class="p">]</span>
                        <span class="n">known</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">new_values</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="n">partial_values</span> <span class="o">+</span> <span class="n">known</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">UnevaluatedDependency</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">late_evaluate_dim_size</span><span class="p">,</span>
                                             <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">provided_values</span>
                                              <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="n">provided_values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="ValueVisitor.visit_TensorArgument"><a class="viewcode-back" href="../../devito.html#devito.arguments.ValueVisitor.visit_TensorArgument">[docs]</a>    <span class="k">def</span> <span class="nf">visit_TensorArgument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="p">,</span> <span class="n">DimensionParameter</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_values</span><span class="p">[</span><span class="n">o</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">param</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="Dependency"><a class="viewcode-back" href="../../devito.html#devito.arguments.Dependency">[docs]</a><span class="k">class</span> <span class="nc">Dependency</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Object that represents an edge between two nodes on a dependency graph</span>
<span class="sd">        Dependencies are directional, i.e. A -&gt; B != B -&gt; A</span>
<span class="sd">        A dependency can either by of type :class:`ValueDependency` in which case this</span>
<span class="sd">        dependency will be followed for value derivation or it can be of type</span>
<span class="sd">        :class:`VerifyDependency` in which case this dependency will be followed for</span>
<span class="sd">        verification. Both types of dependencies may exist between a pair of nodes.</span>
<span class="sd">        However, only a single dependency of a type may exist between any pair of nodes.</span>
<span class="sd">        :param obj: Dependencies have a source node and a target node. The source node</span>
<span class="sd">                    will store the dependency object on itself. The obj referred to here</span>
<span class="sd">                    is the target node of the dependency.</span>
<span class="sd">        :param param: An optional parameter that might be required to evaluate the</span>
<span class="sd">                      relationship being defined by this Dependency. e.g. when a Dimension</span>
<span class="sd">                      derives its value from a SymbolicFunction&#39;s shape, this param</span>
<span class="sd">                      carries the index of a dimension in the SymbolicFunction&#39;s shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_Value</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_Verify</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">param</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;(</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span></div>


<div class="viewcode-block" id="ValueDependency"><a class="viewcode-back" href="../../devito.html#devito.arguments.ValueDependency">[docs]</a><span class="k">class</span> <span class="nc">ValueDependency</span><span class="p">(</span><span class="n">Dependency</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A Dependency that specifies that one argument gets its value from another &quot;&quot;&quot;</span>
    <span class="n">is_Value</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="VerifyDependency"><a class="viewcode-back" href="../../devito.html#devito.arguments.VerifyDependency">[docs]</a><span class="k">class</span> <span class="nc">VerifyDependency</span><span class="p">(</span><span class="n">Dependency</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A Dependency that specifies that one argument verifies the value of another &quot;&quot;&quot;</span>
    <span class="n">is_Verify</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="UnevaluatedDependency"><a class="viewcode-back" href="../../devito.html#devito.arguments.UnevaluatedDependency">[docs]</a><span class="k">class</span> <span class="nc">UnevaluatedDependency</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">consumer</span><span class="p">,</span> <span class="n">evaluator</span><span class="p">,</span> <span class="n">extra_param</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumer</span> <span class="o">=</span> <span class="n">consumer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">evaluator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_param</span> <span class="o">=</span> <span class="n">extra_param</span>

<div class="viewcode-block" id="UnevaluatedDependency.evaluate"><a class="viewcode-back" href="../../devito.html#devito.arguments.UnevaluatedDependency.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">known_values</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">consumer</span><span class="p">,</span> <span class="n">known_values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_param</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="runtime_arguments"><a class="viewcode-back" href="../../devito.html#devito.arguments.runtime_arguments">[docs]</a><span class="k">def</span> <span class="nf">runtime_arguments</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">flatten</span><span class="p">([</span><span class="n">ArgumentVisitor</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">])</span></div>


<div class="viewcode-block" id="log_args"><a class="viewcode-back" href="../../devito.html#devito.arguments.log_args">[docs]</a><span class="k">def</span> <span class="nf">log_args</span><span class="p">(</span><span class="n">arguments</span><span class="p">):</span>
    <span class="n">arg_str</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arguments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">):</span>
            <span class="n">arg_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">, shape=</span><span class="si">%s</span><span class="s1">, L2 Norm=</span><span class="si">%d</span><span class="s1">, type=</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">view</span><span class="p">()),</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arg_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;(</span><span class="si">%s</span><span class="s1">, value=</span><span class="si">%s</span><span class="s1">, type=</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Passing Arguments: &quot;</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg_str</span><span class="p">))</span></div>


<div class="viewcode-block" id="find_argument_by_name"><a class="viewcode-back" href="../../devito.html#devito.arguments.find_argument_by_name">[docs]</a><span class="k">def</span> <span class="nf">find_argument_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">haystack</span><span class="p">):</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">haystack</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">filtered</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="runtime_dim_extent"><a class="viewcode-back" href="../../devito.html#devito.arguments.runtime_dim_extent">[docs]</a><span class="k">def</span> <span class="nf">runtime_dim_extent</span><span class="p">(</span><span class="n">dimension</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">find_argument_by_name</span><span class="p">(</span><span class="n">dimension</span><span class="o">.</span><span class="n">end_name</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="o">-</span>\
            <span class="n">find_argument_by_name</span><span class="p">(</span><span class="n">dimension</span><span class="o">.</span><span class="n">start_name</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="retrieve_offsets"><a class="viewcode-back" href="../../devito.html#devito.arguments.retrieve_offsets">[docs]</a><span class="k">def</span> <span class="nf">retrieve_offsets</span><span class="p">(</span><span class="n">ispace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a mapper from :class:`Dimension`s to the min/max integer offsets</span>
<span class="sd">    within ``ispace``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mapper</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="o">.</span><span class="n">dim</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">min_extent</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ispace</span><span class="o">.</span><span class="n">intervals</span><span class="p">}</span>
    <span class="n">mapper</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">d</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_Stepping</span><span class="p">})</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">d</span><span class="o">.</span><span class="n">end_name</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span></div>


<div class="viewcode-block" id="derive_dle_arg_value"><a class="viewcode-back" href="../../devito.html#devito.arguments.derive_dle_arg_value">[docs]</a><span class="k">def</span> <span class="nf">derive_dle_arg_value</span><span class="p">(</span><span class="n">blocked_dim</span><span class="p">,</span> <span class="n">known_values</span><span class="p">,</span> <span class="n">dle_argument</span><span class="p">):</span>
    <span class="n">dim_size</span> <span class="o">=</span> <span class="n">runtime_dim_extent</span><span class="p">(</span><span class="n">dle_argument</span><span class="o">.</span><span class="n">original_dim</span><span class="p">,</span> <span class="n">known_values</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dim_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">UnevaluatedDependency</span><span class="p">(</span><span class="n">blocked_dim</span><span class="p">,</span> <span class="n">derive_dle_arg_value</span><span class="p">,</span> <span class="n">dle_argument</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">dle_argument</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">dle_argument</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">dim_size</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">dle_argument</span><span class="o">.</span><span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">dim_size</span>
    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="get_value"><a class="viewcode-back" href="../../devito.html#devito.arguments.get_value">[docs]</a><span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">consumer</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">known_values</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ValueVisitor</span><span class="p">(</span><span class="n">consumer</span><span class="p">,</span> <span class="n">known_values</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Opesci.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>